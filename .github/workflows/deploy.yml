name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '17 */2 * * *'
  workflow_dispatch:
    inputs:
      ignore_cache:
        description: 'Ignore summarization cache and regenerate summaries?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          npm run install:all
          uv sync

      - name: Handle Summarization Cache
        uses: actions/cache@v4
        with:
          path: output/summarize.json
          # Unique key ensures a new version is saved at the end of every run
          key: noctua-summaries-${{ github.run_id }}
          # Restore-keys pulls the most recent entry starting with this prefix
          restore-keys: |
            noctua-summaries-

      - name: Download feeds
        run: npm run download
        continue-on-error: true

      - name: Filter feeds
        run: npm run filter
        continue-on-error: true

      - name: Check for API key
        id: check_api_key
        run: |
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "has_api_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_api_key=false" >> $GITHUB_OUTPUT
          fi

      - name: Summarize feeds (AI)
        if: steps.check_api_key.outputs.has_api_key == 'true'
        run: |
          if [ "${{ github.event.inputs.ignore_cache }}" = "true" ]; then
            npm run summarize -- --ignore-cache
          else
            npm run summarize
          fi
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Build website
        run: npm run build:website

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './output/app'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
